<!DOCTYPE HTML>
<html>
	<head>
		<title>Clipping Region Editor</title>
		<meta charset="utf-8"/>
		<style>
			#img {display: none;}
			#canvas { position:absolute; z-index:2; background: #00ff6563;}
			#canvas0 { position: relative; z-index:1}
		</style>
	</head>
	<body>
	 <img id="img"/>
	 <div style='height:352px'>
		<canvas id="canvas">Upgrade your Browser</canvas>	     
	    <canvas id="canvas0">Upgrade your Browser</canvas>	 	
     </div>
	 <canvas id='clipper' style='background: yellow'></canvas>
	 <p></p>
	 <div id='controls'></div>
	 <script src='points.js'></script>
	 <script>
		let cctv_image = "109.png"

		window.onload = function(){
			let alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ"
			var ctls = document.getElementById('controls')
			var canvas = document.getElementById('canvas');
			var clipper = document.getElementById('clipper');
			var ctxClipper = clipper.getContext('2d')

			var ctx = canvas.getContext('2d');	
				ctx.globalCompositeOperation='source-over'; // destination-out, ctx.globalAlpha=0.3;
				ctx.font = '11pt Helvetica'
				ctx.save()
			var canvas0 = document.getElementById('canvas0');
			var ctx0 = canvas0.getContext('2d')
			var img = document.getElementById("img");

			let type = 'range'
			let Index = cctv_image.split('.')[0]
			let cam = points[Index]

			for(let idx=0; idx < cam.length; idx++){
				let point = points[Index][idx];
				let ctl0 = document.createElement('input')
				let ctl1 = document.createElement('input')

				ctl0.setAttribute('id', 'p'+idx+'-x')				
				ctl0.setAttribute('type', type)
				ctl0.setAttribute('min', 0)
				ctl0.setAttribute('max', 640)
				ctl0.setAttribute('title', 'X value')
				ctl0.setAttribute('value', point.x)
				ctl0.addEventListener('change', clipImage, false)

				ctl1.setAttribute('id', 'p'+idx+'-y')				
				ctl1.setAttribute('type', type)				
				ctl1.setAttribute('min', 0)
				ctl1.setAttribute('max', 352)
				ctl1.setAttribute('title', 'Y value')
				ctl1.setAttribute('value', point.y)				
				ctl1.addEventListener('change', clipImage, false)

				let text = idx == 0 ? '*' : alphabet.charAt(idx-1) + ": "
				let txt = document.createTextNode( text )
				let div = document.createElement('DIV')
				div.style.float = 'left'
				div.classList.add('host')
				div.appendChild(txt)
				div.appendChild(ctl0)
				div.appendChild(ctl1)
				ctls.appendChild(div)
			}

			var clipImage = function(){				
				console.log('clipImage')

				ctx.restore()				
				ctx.clearRect(0,0, canvas.width, canvas.height)
				ctx.fillStyle = 'red'
				ctx.strokeStyle = 'red' //'#FFF'				
				ctx.beginPath()

				document.querySelectorAll('div.host').forEach((el,idx)=>{
					let kids = el.childNodes
					let p = {x: kids[1].value, y: kids[2].value}

					if (idx == 0){
						ctx.moveTo(p.x, p.y);
						ctxClipper.moveTo(p.x, p.y);
						ctx.fillText( '*', p.x, p.y)
					} else {
						ctx.lineTo(p.x, p.y)
						ctxClipper.lineTo(p.x, p.y)
						ctx.fillText( alphabet.charAt(idx-1), p.x, p.y)
					}
				})
		
				/*
				// when u need to save your changes
				points = [];

				document.querySelectorAll('div.host').forEach((el,idx)=>{
					let kids = el.childNodes
					let p = {x: kids[1].value, y: kids[2].value}
					console.log(`{x:${p.x}, y: ${p.y}},`)
				})
				*/
				ctx.closePath()
				ctx.stroke()		
				ctxClipper.clip()		
				ctxClipper.drawImage(img, 0, 0);	
			}

			document.querySelectorAll(`input[type="${type}"]`).forEach((el,idx)=>{
				el.addEventListener('change', function(){
						let title = (this.getAttribute('id').indexOf('-x') ? 'X value' : 'Y value ') + ` (${this.value})`
						this.setAttribute('title', title)
						clipImage()
				}, false)
			})

			img.onload = function(){
				canvas.width = this.width
				canvas.height = this.height	

				canvas0.width = this.width	
				canvas0.height = this.height

				clipper.width = this.width
				clipper.height = this.height

				ctx0.drawImage(img, 0, 0);					
				clipImage()
			}

			img.src = cctv_image
		}
	 </script>
	</body>
</html>
